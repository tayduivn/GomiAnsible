#! /bin/zsh

ANSIBLE_PATH="${HOME}/.ansible"
PROJECT_PATH=`pwd | sed 's%\(.*/ansible_origin\)/.*%\1%'`
REPLACE_DIR="rm -rf ${ANSIBLE_PATH} && mv -f ${PROJECT_PATH} ${ANSIBLE_PATH} && cd ${ANSIBLE_PATH};"
SECRET_EDIT="ansible-vault edit ~${ANSIBLE_PATH}/secrets.yml"
DEPLOY="ansible-playbook --ask-vault-pass"


MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'
CHECK_MARK="\033[0;32m\xE2\x9C\x94\033[0m"
SP_LINE="================================================"

# $1: task
# $2..: options
function gomsible() {
  TARGET=""
  ENV=""
  BRANCH=""
  HOTFIX="false"

  WELLCOME="\n\n${SP_LINE}\nWellcome to Gomi Ansible!\nPlease read README\n${CYAN}https://github.com/gomicorp/GomiAnsible/${NC}\n${SP_LINE}"

  args=("$@")

  case $args[1] in
    "")
      # 도움말
      echo "$WELLCOME"
      ;;
    "help")
      # 도움말
      echo "$WELLCOME"
      ;;
    "init")
      __gomsible_init
      ;;
    "secredit")
    # secret 수정 함수 실행
      __gomsible_secret_edit
      ;;
    "setdir")
      # set dir
      __gomsible_ask_replacing_dir
      ;;
    "deploy")
      # ansible-playbook
      # 옵션 파싱
      # args 는 전체 arg
      __gomsible_params_purify ${args}
      echo -ne "${YELLOW}deploy to ${TARGET} ${ENV} server ${NC}"\\r
      sleep 0.3
      echo -ne "${YELLOW}deploy to ${TARGET} ${ENV} server \033[1;37m\xe2\x9c\x88${NC}"\\r
      sleep 0.3
      echo -ne "${YELLOW}deploy to ${TARGET} ${ENV} server \033[1;37m\xe2\x9c\x88 \033[1;36m\xe2\x9c\x88${NC}\\r"
      sleep 0.3
      echo -ne "${YELLOW}deploy to ${TARGET} ${ENV} server \033[1;37m\xe2\x9c\x88 \033[1;36m\xe2\x9c\x88 \033[1;34m\xe2\x9c\x88${NC}\n"
      sleep 0.3
      if [ '${ENV}' = 'production' ]; then
        echo "${RED}!!! YOU ARE DEPLOYING TO PRODUCTION !!! \nHope you know what you do.${NC}"
        read -n "_?Press enter to continue"
      fi
      if [ ${#TARGET} -lt 1 ]; then
        echo "${SP_LINE}\n${RED}ERROR :: Target option must be required.(-t)"
      elif [ ${#ENV} -lt 1 ]; then
        echo "${SP_LINE}\n${RED}ERROR :: Environment option must be required.(-e)"
      else
        __gomsible_deploy ${TARGET} ${ENV} ${HOTFIX} ${BRANCH}
      fi
      ;;
      *)
        echo "${RED}Unexpected task \`$args[1]${NC}\`"
      ;;
  esac
}

function __gomsible_init() {
  HEADER="${SP_LINE}\nInitiate to fit your ansible for gomi ansible\n${SP_LINE}"
  clear
  echo "${HEADER}"
  sleep 0.4
  echo -e "Set your github name and password for git tasks"
  read -n "username?Type your Github name : "
  read -n "password?Type your Github password : "
  echo "gituser: ${username}\ngitpassword: ${password}" > secrets.yml
  eval "ansible-vault encrypt secrets.yml"
  echo -e "${CHECK_MARK} Your github account is saved.\nYou can rewrite use command \"${MAGENTA}gomsible secredit${NC}\""
  read -n "_?Press enter to continue"
  clear
  echo -e "${HEADER}"
  __gomsible_ask_replacing_dir
  RC="${HOME}/.zshrc"
  REGIST="source ${ANSIBLE_PATH}/bin/gomsible"
  if ! grep -q ${REGIST} "${RC}"; then
    echo ${REGIST} >> ${RC}
  fi
  echo "  ___                  ___  "
  echo " (o o)                (o o) "
  echo "(  V  ) Setting Done (  V  )"
  echo "--m-m------------------m-m--"
  eval "source ${HOME}/.zshrc"
}

function __gomsible_ask_replacing_dir() {
  echo -e "Checking directory.."
  sleep 1
  if [ "${PROJECT_PATH}" = "${ANSIBLE_PATH}" ]; then
    echo "${MAGENTA}Directory is already set.${NC}"
  else
      echo -e "You should replace ansible default directory to use GomiAnsible.\n"
      echo -e "You can do this later using command \"${MAGENTA}gomsible setdir${NC}\"\n"
      echo -e "(${RED}It will overwrite ansible default directory.${NC})\n"
      read "do?Replace now? [y/any(no)] :"
      if [ "${do}" = "y" ]; then
        eval "${REPLACE_DIR}"
      fi
  fi
}

function __gomsible_params_purify() {
  # 옵션들을 받음
  args=("$@")
  # 두번째 arg부터 옵션
  for ((i=2; i < $#; i++))
{
  case $args[i] in
    "-t")
      TARGET="${args[i+1]}"
    ;;
    "-e")
      ENV="${args[i+1]}"
    ;;
    "--hotfix")
      HOTFIX="true"
    ;;
    "-b")
      BRANCH="${args[i+1]}"
    ;;
  esac
}
}

function __gomsible_secret_edit() {
  eval "ansible-vault edit ${ANSIBLE_PATH}/secrets.yml"
}

function __gomsible_deploy() {
  TARGET=$1
  ENV=$2
  TARGET_HOST="${TARGET}_${ENV}"
  BRANCH=$4
  IS_HOTFIX=""
  if [ $3 ]; then
    IS_HOTFIX=" -e hotfix=true"
  fi
  # branch
  if [ ${#BRANCH} -ge 1 ]; then
    BRANCH=" -e git_version=$4"
  else
    BRANCH=""
  fi
  COMMAND="${DEPLOY} ${ANSIBLE_PATH}/store_deploy.yml -i ${ANSIBLE_PATH}/hosts/inventory -e target_host=${TARGET_HOST} -e \"@${ANSIBLE_PATH}/vars/${TARGET_HOST}.json\" ${IS_HOTFIX}${BRANCH}"
  eval ${COMMAND}
}
